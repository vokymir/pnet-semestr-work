@page "/souteze"
@inject BirdApiClient BAC
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage

<PageTitle>SoutÄ›Å¾e</PageTitle>

<h1 class="mb-4">ğŸ•Šï¸ SoutÄ›Å¾e</h1>
<HelpBox InitiallyVisible="false">
PÅ™idej se do soutÄ›Å¾e, aby ses mohl(a) porovnat s ostatnÃ­mi. <br/>
KaÅ¾dÃ¡ soutÄ›Å¾ mÃ¡ svÅ¯j speciÃ¡lnÃ­ kÃ³d. BuÄ si mÅ¯Å¾eÅ¡ najÃ­t veÅ™ejnou soutÄ›Å¾, anebo TÄ› nÄ›kdo musÃ­ pozvat a dÃ¡t Ti ten kÃ³d. Pak se pÅ™idÃ¡Å¡ pomocÃ­ tlaÄÃ­tka s klÃ­Äem (ğŸ”‘). <br />
Taky je moÅ¾nÃ½ nÄ›jakou soutÄ›Å¾ zaloÅ¾it. To se dÄ›lÃ¡ na tlaÄÃ­tku s plusem (â•), ale to je spÃ­Å¡ pro vedoucÃ­, anebo technickÃ© typy lidÃ­.
</HelpBox>

<div class="mb-3 d-flex flex-wrap align-items-end gap-3">
    <div>
        <label for="filter" class="form-label">ğŸ¯ Filtrovat soutÄ›Å¾e:</label>
        <select id="filter" class="form-select w-auto" @bind="SelectedFilter">
            <option value="all">VÅ¡echny</option>
            <option value="mine">Moje</option>
            <option value="participating">ÃšÄastnÃ­m se</option>
        </select>
    </div>

    <div class="ms-auto">
        <Button Type="ButtonType.Link" To="/soutez/nova" Color="ButtonColor.Primary" class="me-2">
            â• VytvoÅ™it soutÄ›Å¾
        </Button>
        <Button Color="ButtonColor.Secondary" @onclick="ShowModal">
            ğŸ”‘ PÅ™idat se do soutÄ›Å¾e
        </Button>
    </div>
</div>

<JoinEventModal @ref="JoinModal" User="U" OnEventJoined="LoadEvents" />

<div class="row">
    @if (FilteredEvents is null || !FilteredEvents.Any())
    {
        <div class="text-muted">Å½Ã¡dnÃ© soutÄ›Å¾e nebyly nalezeny.</div>
    }
    else
    {
        @foreach (var e in FilteredEvents)
        {
            var isMine = MyEventIds.Contains(e.Id);
            var myWatchers = Watcherss
                .Where(w => e.Participants?.Any(p => p.Id == w.Id) == true)
                .ToList() ?? new();

            <div class="col-12 col-sm-6 col-lg-4 mb-4">
                <Card class="shadow-sm h-100">
                    <CardBody>
                        <CardTitle class="fs-5 fw-bold">@e.Name</CardTitle>
                        <CardText>
                            <div><strong>ğŸ”— KÃ³d:</strong> @e.PublicIdentifier</div>
                            <div><strong>ğŸŒ VeÅ™ejnÃ¡:</strong> @(e.IsPublic ? "Ano" : "Ne")</div>

                            @if (isMine)
                            {
                                <div class="mt-2 badge bg-success">ğŸŸ¢ Moje soutÄ›Å¾</div>
                            }

                            @if (myWatchers.Any())
                            {
                                <div class="mt-2">
                                    <strong>ğŸ¦ ÃšÄastnÃ­ se moji pozorovatelÃ©:</strong>
                                    <ul class="ps-3 mb-0">
                                        @foreach (var w in myWatchers)
                                        {
                                            <li>@w.FirstName @w.LastName</li>
                                        }
                                    </ul>
                                </div>
                            }
                        </CardText>

                        <div class="d-flex justify-content-between mt-3">
                            <Button Color="ButtonColor.Primary" Type="ButtonType.Link"
                                    To="@($"/soutez/{e.PublicIdentifier}")">
                                ğŸ” Zobrazit
                            </Button>
                            <Button Color="ButtonColor.Success"
                                    @onclick="() => OpenJoinModal(e.PublicIdentifier)">
                                ğŸ SoutÄ›Å¾it
                            </Button>
                        </div>
                    </CardBody>
                </Card>
            </div>
        }
    }
</div>

@code {
    private UserDto? U = null;
    private List<EventDto> AllEvents = new();
    private List<EventDto> FilteredEvents = new();
    private HashSet<int> MyEventIds = new();
    private JoinEventModal? JoinModal;
    private List<WatcherDto> Watcherss = new();

    private string selectedFilter = "all";
    private string SelectedFilter
    {
        get => selectedFilter;
        set
        {
            if (selectedFilter != value)
            {
                selectedFilter = value;
                ApplyFilter();
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await LoadUser();
            await LoadEvents();
            ApplyFilter();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Chyba pÅ™i naÄÃ­tÃ¡nÃ­ soutÄ›Å¾Ã­: {ex.Message}");
        }
    }

    private async Task LoadUser(){
        U = await LocalStorage.GetItemAsync<UserDto>("userDto");
        if (U is null) throw new Exception("Nelze naÄÃ­st userDto z local storage.");

        Watcherss = U?.Watchers?.ToList() ?? new List<WatcherDto>();
        if (U?.CuratedWatchers is not null)
            foreach (var w in U.CuratedWatchers){
                bool shouldAdd = true;
                foreach (var ww in Watcherss)
                    if (w.Id == ww.Id){
                        shouldAdd = false;
                        break;
                    }
                if (shouldAdd)
                    Watcherss.Add(w);
            }
    }

    private async Task LoadEvents(){
        var seenIds = new HashSet<int>();

        // Moje soutÄ›Å¾e
        if (U is null) throw new Exception("UserDto is not loaded.");
        var mine = await BAC.Event_GetByUserIdAsync(U.Id);
        foreach (var e in mine)
        {
            e.Participants ??= new List<WatcherDto>();
            if (seenIds.Add(e.Id))
            {
                AllEvents.Add(e);
                MyEventIds.Add(e.Id);
            }
        }

        // SoutÄ›Å¾e, kde se ÃºÄastnÃ­ moji ptÃ¡ÄkaÅ™i

        if (Watcherss is not null)
        {
            foreach (var w in Watcherss)
            {
                var joined = await BAC.Event_GetByWatcherIdAsync(w.Id);
                foreach (var e in joined)
                {
                    e.Participants ??= new List<WatcherDto>();

                    if (seenIds.Add(e.Id))
                    {
                        AllEvents.Add(e);
                    }

                    // PÅ™idat ÃºÄastnÃ­ka, pokud chybÃ­
                    if (!e.Participants.Any(p => p.Id == w.Id))
                    {
                        e.Participants.Add(new WatcherDto { Id = w.Id });
                    }
                }
            }
        }

        // vsechny public
        var evs = await BAC.Event_GetAllAsync();
        foreach (var e in evs){
            if (e.IsPublic && seenIds.Add(e.Id))
            {
                AllEvents.Add(e);
            }
        }
    }

    private void ApplyFilter()
    {
        FilteredEvents = SelectedFilter switch
        {
            "mine" => AllEvents.Where(e => MyEventIds.Contains(e.Id)).ToList(),
            "participating" => AllEvents
            .Where(e => Watcherss.Any(w => e.Participants?.Any(p => p.Id == w.Id) == true) == true)
            .ToList(),
            _ => AllEvents.ToList()
        };
    }

    private async Task ShowModal()
    {
        if (JoinModal is not null)
            await JoinModal.ShowAsync(U);
    }

    private async Task OpenJoinModal(string publicIdentifier)
    {
        if (JoinModal is not null)
        {
            await JoinModal.ShowAsync(U, publicIdentifier);
        }
    }
}
